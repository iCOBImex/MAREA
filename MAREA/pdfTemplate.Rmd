---
subtitle: "Producido por MAREA"
author: "Visite: www.turfeffect.org/apps"
output: 
    pdf_document: 
      fig_caption: yes
      number_sections: yes
      toc: yes
      toc_depth: 4
params:
  comunidad: ""
  reserva: ""
  rc: ""
  results_bio: ""
  results_bio_i: ""
  results_soc: ""
  results_gov: ""
---

---
title: `r paste("Reporte para", params$rc, "en", params$comunidad)`
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = F, fig.height = 3, warning = F, message = F, results = 'asis')

```

```{r cargar paquetes}

suppressPackageStartupMessages({
  library(gridExtra)
  library(MPAtools)
  library(stargazer)
  library(shiny)
  library(scales)
  library(tidyverse)
})

```

\clearpage

# Acerca del reporte

*Acentos y caracteres especiales omitidos*

  - Resumen y leyenda
  
  - Resumen de muestreo
  
  - Modelos utilizados
  
  - Par Figura - Tabla
  
      - Interpretacion de las figuras
      
      - Interpretacion de las tablas
  
  - Mensajes y advertencias
  
\clearpage

# Resumen

<center>

**Leyenda**

![Leyenda para el resumen de indicadores.](legend2.gif)

</center>

```{r}

if(is.null(params$results_bio)){
  results_bio <- tibble::tibble(
    Ind = NA,
    e = NA,
    p = NA,
    string = NA,
    color = NA,
    model = list(NA),
    plot = list(NA)
  )
} else {results_bio <- params$results_bio}

if(is.null(params$results_bio_i)){
  results_bio_i <- tibble::tibble(
    Ind = c(1, 2, 3),
    e = NA,
    p = NA,
    string = NA,
    color = NA,
    model = list(NA),
    plot = list(NA)
  )
} else {results_bio_i <- params$results_bio_i}

if(is.null(params$results_soc)){
  results_soc <- tibble::tibble(
    Ind = c(1,2),
    e = NA,
    p = NA,
    string = NA,
    color = NA,
    model = list(NA),
    plot = list(NA)
  )
} else {results_soc <- params$results_soc}

if(is.null(params$results_gov$results)){
  results_gov <- tibble::tibble(
    Ind = seq(1,13),
    e = NA,
    p = NA,
    string = NA,
    color = NA,
    model = list(NA),
    plot = list(NA)
  )
} else {results_gov <- params$results_gov$results}

gov <- params$results_gov$data %>%
    filter(Community == params$comunidad, Q2_Name %in% c(params$reserva, NA))
  
```

```{r}
summary_table(results_bio, results_bio_i, results_soc, results_gov) %>% 
  knitr::kable(align = "r")
```


\clearpage

# Ecologicos

## Peces

```{r, fig.cap="Indice de diversidad de Shannon"}
if(!is.na(results_bio$plot[[1]])) {cat("### Indice de diversidad de Shannon\n")
  results_bio$plot[[1]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[1]])){reg_table(model = results_bio$model[[1]],
                                             title = "Tabla de regresion para el indice de diversidad de Shannon",
                                             dep.var.labels = "Shannon (H'/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[1]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Riqueza especifica"}
if(!is.na(results_bio$plot[[2]])) {cat("### Riqueza\n")
  results_bio$plot[[2]]}
```

```{r, results = 'asis'}

if(!is.na(results_bio$model[[2]])) {reg_table(model = results_bio$model[[2]],
                                              title = "Tabla de regresion para riqueza especifica",
                                              dep.var.labels = "Riqueza (Spp/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[2]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Densidad de organismos maduros"}
if(!is.na(results_bio$plot[[3]])) {cat("### Organismos maduros\n")
  results_bio$plot[[3]]}
```

```{r, results = 'asis'}

if(!is.na(results_bio$model[[3]])) {reg_table(results_bio$model[[3]],
                                              title = "Tabla de regresion para densidad organismos maduros",
                                              dep.var.labels = "Organismos > Lm")}
```

```{r}
if(!is.na(results_bio$plot[[3]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Densidad de organismos"}
if(!is.na(results_bio$plot[[4]])) {cat("### Densidad\n")
  results_bio$plot[[4]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[4]])) {reg_table(results_bio$model[[4]],
                                              title = "Tabla de regresion para densidad de organismos",
                                              dep.var.labels = "Densidad (Organismos/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[4]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Densidad de especies objetivo"}
if(!is.na(results_bio$plot[[5]])) {cat("### Densidad de especies objetivo\n")
  results_bio$plot[[5]]}

```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[5]])) {reg_table(results_bio$model[[5]],
                                              title = "Tabla de regresion para densidad de especies objetivo",
                                              dep.var.labels = "Densidad (Organismos/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[5]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Nivel trofico medio"}
if(!is.na(results_bio$plot[[6]])){cat("### Nivel trofico\n")
  results_bio$plot[[6]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[6]])) {reg_table(results_bio$model[[6]],
                                              title = "Tabla de regresion para nivel trofico medio",
                                              dep.var.labels = "Nivel trofico")}
```

```{r}
if(!is.na(results_bio$plot[[6]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Biomasa"}
if (!is.na(results_bio$plot[[7]])) {cat("### Biomasa\n")
  results_bio$plot[[7]]}

```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[7]])) {reg_table(results_bio$model[[7]],
                                              title = "Tabla de regresion para biomasa",
                                              dep.var.labels = "Biomasa (Kg/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[7]])) {cat("\\clearpage")}
```

```{r, fig.cap = "Biomasa de especies objetivo"}
if (!is.na(results_bio$plot[[8]])) {cat("### Biomasa de especies objetivo\n")
  results_bio$plot[[8]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio$model[[8]])) {reg_table(results_bio$model[[8]],
                                              title = "Tabla de regresion para biomasa de especies objetivo",
                                              dep.var.labels = "Biomasa (Kg/transecto)")}
```

```{r}
if(!is.na(results_bio$plot[[8]])) {cat("\\clearpage")}
```

## Invertebrados

```{r}
if(!is.na(results_bio_i$plot[[1]])) {cat("### Indice de diversidad de Shannon\n")
  results_bio_i$plot[[1]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio_i$model[[1]])){reg_table(results_bio_i$model[[1]],
                                               title = "Tabla de regresion para indice de diversidad de Shannon",
                                               dep.var.labels = "Shannon (H'/transecto)")}
```

```{r}
if(!is.na(results_bio_i$plot[[2]])) {cat("### Riqueza\n")
  results_bio_i$plot[[2]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio_i$model[[2]])) {reg_table(results_bio_i$model[[2]],
                                               title = "Tabla de regresion para riqueza especifica",
                                               dep.var.labels = "Riqueza (Spp/transecto)")}
```

```{r}
if(!is.na(results_bio_i$plot[[3]])) {cat("### Densidad\n")
  results_bio_i$plot[[3]]}
```

```{r, results = 'asis'}
if(!is.na(results_bio_i$model[[3]])) {reg_table(results_bio_i$model[[3]],
                                               title = "Tabla de regresion para densidad de organismos",
                                               dep.var.labels = "Densidad (Organismos/transecto)")}
```


# Socioeconomicos

```{r}
if(!is.na(results_soc$plot[[1]])) {
  cat("## Arribos\n")
  results_soc$plot[[1]]
}

```

```{r, results = 'asis'}

if(!is.na(results_soc$model[[1]])) {
  results_soc$model[[1]] %>%
    stargazer(
      dep.var.labels = "Arribos (Kg/ano)",
      type = "latex",
      dep.var.caption = "",
      report = "vc*",
      single.row = T,
      omit.stat = c("rsq", "n"),
      digits = 2,
      df = F,
      notes = "+p < 0.1, ++p<0.05, +++p<0.001",
      notes.append = FALSE,
      star.char = "+"
    )
}

```


```{r}
if(!is.na(results_soc$plot[[2]])) {
  cat("## Ingresos por arribos\n")
  results_soc$plot[[2]]
}

```

```{r, results = 'asis'}

if(!is.na(results_soc$model[[2]])) {
  results_soc$model[[2]] %>%
    stargazer(
      dep.var.labels = "Arribos (Kg/ano)",
      type = "latex",
      dep.var.caption = "",
      report = "vc*",
      single.row = T,
      omit.stat = c("rsq", "n"),
      digits = 2,
      df = F,
      notes = "+p < 0.1, ++p<0.05, +++p<0.001",
      notes.append = FALSE,
      star.char = "+"
    )
}

```

\clearpage

# Gobernanza

## Resumen demografico

El questionario de gobernanza se realizo en `r dim(gov)[1]` miembros de la comunidad. Los demograficos basicos son:

```{r, fig.height = 7.5, fig.width = 8}
gender <- ggplot(gov, aes(x = Gender)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Genero") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

age <- ggplot(gov, aes(x = Age)) +
  geom_histogram(aes(y = (..count..)/sum(..count..)), fill = "steelblue", binwidth = 5, color = "black") +
  theme_bw() +
  ggtitle(label = "Edad") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

occ <- ggplot(gov, aes(x = Occupation)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Ocupacion") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

TonC <- ggplot(gov, aes(x = TimeOnCommunity)) +
  geom_histogram(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black", binwidth = 5) +
  theme_bw() +
  ggtitle(label = "Tiempo en la comunidad") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

education <- ggplot(gov, aes(x = Education)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Nivel de educacion") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

cobi_diver <- ggplot(gov, aes(x = Diver)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Buzo de COBI") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

grid.arrange(gender, age, occ, TonC, education, cobi_diver)
```

\clearpage

## Acceso a la pesqueria

El acceso a la pesqueria se maneja por medio de: `r filter(gov, !is.na(Q7)) %>% {unique(.$Q7)}`.

```{r}
cat(paste0("Mensaje: ",results_gov$string[[1]]))
```

## Numero de pescadores

```{r}
cat(paste0("Mensaje: ",results_gov$string[[2]]))
```

```{r}
gov %>% 
  select(contains("Q10")) %>% 
  set_names(c("Antes", "Despues")) %>% 
  gather(Dim, Value) %>% 
  filter(!is.na(Value)) %>% 
  ggplot(aes(x = Dim, y = Value)) +
  geom_boxplot(fill = "steelblue") +
  stat_summary(geom = "point", fun.y = mean, color = "black", size = 10, pch = "*") +
  theme_bw() +
  labs(x = "") +
  ggtitle(label = "Numero de pescadores")
```


## Reconocimiento legal de la reserva

```{r}
cat(paste0("Mensaje: ",results_gov$string[[3]]))
```

Ask CAIO if `NA` means not answered or that he/she didnt have to answer to know if I should `na.rm = T`

```{r}
gov %>% 
  select(Interviewee, contains("Q5")) %>% 
  set_names(c("Interviewee", "Reconocida", "En proceso", "Interesados")) %>% 
  gather(Dim, Value, -Interviewee) %>% 
  mutate(N = length(unique(Interviewee))) %>% 
  group_by(Dim, Value, N) %>% 
  count() %>%   
  mutate(n = n/N) %>% 
  ggplot(aes(x = Value, y = n)) +
  geom_col(fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Reconocimiento legal de la reserva") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)
```

\clearpage

## Tipo de reserva

**MISSING FROM DATABASE SO FAR**

```{r}
cat(paste0("Mensaje: ",results_gov$string[[4]]))
```

\clearpage

## Grado de pesca ilegal

```{r}
cat(paste0("Mensaje: ",results_gov$string[[5]]))
```

```{r, fig.height = 10, fig.width = 8}
q13 <- ggplot(gov, aes(x = Q13)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Vigilancia y procuracion percivida") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q14 <- gov %>% 
  select(contains("Q14")) %>% 
  set_names(c("De la comunidad en ZNP", "Foraneo en ZNP", "De la comunidad fuera de ZNP", "Foraneo fuera de ZNP")) %>% 
  gather(Dim, Value) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Pesca ilegal dentro y fuera de la reserva por miembros de la comunidad y foraneos") +
  coord_flip() +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q19 <- gov %>% 
  select(contains("Q19")) %>% 
  set_names(c("Antes", "Despues")) %>% 
  gather(Dim, Value) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Pesca ilegal en la region") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q20 <- gov %>% 
  select(contains("Q20")) %>% 
  set_names(c("Yo pesco dentro de la ZNP", "Otros pescan dentro de la ZNP", "Foraneos pescan dentro de la ZNP")) %>% 
  gather(Dim, Value) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Percepcion de infractores") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

grid.arrange(q13, q14, q19, q20, ncol = 1)

```

\clearpage

## Plan de manejo

```{r}
cat(paste0("Mensaje: ",results_gov$string[[6]]))
```

Ask CAIO if `NA` means not answered or that he/she didnt have to answer to know if I should `na.rm = T`

```{r}
gov %>% 
  select(Q6) %>% 
  gather(Dim, Value) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Existe un plan de manejo?") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)
```

\clearpage

## Procuracion y vigilancia de la reserva

```{r}
cat(paste0("Mensaje: ",results_gov$string[[7]]))
```

Los principales actores para la procuracion y vigilancia son: `r filter(gov, !is.na(Q4_3)) %>% {unique(.$Q4_3)}`.

La vigilancia se hace por medio de: `r filter(gov, !is.na(Q8)) %>% {unique(.$Q8)}`.

```{r, fig.height = 7.5, fig.width = 8}
q15 <- gov %>% 
  ggplot(aes(x = Q15)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Percepcion de la procuracion por el gobierno") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q16 <- gov %>% 
  ggplot(aes(x = Q16)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  labs(x = "") +
  ggtitle(label = "La procuracion funciona mejor cuando el gobierno esta involucrado") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q17 <- gov %>% 
  ggplot(aes(x = Q17)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "La procuracion funciona mejor cuando la comunidad esta involucrada") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

grid.arrange(q15, q16, q17)
```

\clearpage

## Tamano de la reserva

**MISSING FROM DATABASE SO FAR**

```{r}
cat(paste0("Mensaje: ",results_gov$string[[8]]))
```

## Razonamiento para el diseno de la reserva

```{r}
cat(paste0("Mensaje: ",results_gov$string[[9]]))
```

```{r}
gov$Q2_Reason <- "blah blah blah blah blah"

gov %>% 
  mutate(Sujeto = 1:length(Interviewee)) %>% 
  select(Sujeto, Razon = Q2_Reason) %>% 
  knitr::kable()

```

\clearpage

## Pertenencia y Tipo de organizacion pesquera

Los siguientes tipos de organizaciones pesqueras existen: `r filter(gov, !is.na(Q1)) %>% {unique(.$Q1)}`.

## Representacion

La creacion de las reservas fue **motivada** por: `r filter(gov, !is.na(Q3)) %>% {unique(.$Q3)}`.

El **manejo** de las reservas se lleva a cabo por: `r filter(gov, !is.na(Q4_1)) %>% {unique(.$Q4_1)}`.

El **monitoreo** de las reservas se lleva a cabo por: `r filter(gov, !is.na(Q4_2)) %>% {unique(.$Q4_2)}`.

Las **decisiones** se toman por: `r filter(gov, !is.na(Q12)) %>% {unique(.$Q12)}`.

Tambien deberian de participar: `r filter(gov, !is.na(Q12_1)) %>% {unique(.$Q12_1)}`.

## Reglamentacion interna

```{r}
cat(paste0("Mensaje: ",results_gov$string[[10]]))
```

```{r}
gov %>% 
  filter(!is.na(Q9)) %>% 
  ggplot(aes(x = Q9)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Reglamentacion interna") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)
```

\clearpage

## Efectividad percibida

```{r}
cat(paste0("Mensaje: ",results_gov$string[[11]]))
```

```{r, fig.height = 10, fig.width = 8}

q21_1 <- gov %>% 
  select(contains("Q21_1")) %>% 
  set_names(c("Riqueza", "Tallas", "Densidad", "Biomasa", "Abundancia de depredadores")) %>% 
  gather(Dim, Value) %>% 
  filter(!is.na(Value)) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Cambios biologicos") +
  coord_flip() +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q21_2 <- gov %>% 
  select(contains("Q21_2")) %>% 
  set_names(c("Total landings", "Managed species landings", "Fisheries revenue", "Alternative economic activities")) %>% 
  gather(Dim, Value) %>% 
  filter(!is.na(Value)) %>% 
  ggplot(aes(x = Value)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  facet_grid(~Dim) +
  theme_bw() +
  ggtitle(label = "Socioeconomic changes") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q21_3 <- gov %>% 
  ggplot(aes(x = Q21_3)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Local governance") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q22 <- gov %>% 
  ggplot(aes(x = Q22)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Impacto general") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

q23 <- gov %>% 
  ggplot(aes(x = Q23)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue", color = "black") +
  theme_bw() +
  ggtitle(label = "Percepcion de efectividad") +
  labs(x = "", y = "Proporcion") +
  scale_y_continuous(labels = percent)

grid.arrange(q21_1, q21_2, q21_3, q22, q23, ncol = 1)

```


